<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="xaHWbGrH27PtIRsHQwRbAzWeQmtdbVP8Sj8IoFGMFhA" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/safari-pinned-tab.svg?v=5.1.4" color="#222">


  <link rel="manifest" href="/site.webmanifest">


  <meta name="msapplication-config" content="/browserconfig.xml" />



  <meta name="keywords" content="Java," />





  <link rel="alternate" href="/atom.xml" title="扔掉笔记 ᐛ" type="application/atom+xml" />






<meta name="description" content="4种引用对比 强引用: 只要强引用还在就不会被 GC，JVM 宁愿抛出 OutOfMemoryError 错误也不会回收；  软引用(SoftReference): 用来描述非必需对象, GC 时发现内存不够时（Heap 内存超阈值）将会被回收。当垃圾回收器决定对其回收时，会先清空它的 SoftReference，也就是说 SoftReference 的 get() 方法将会返回 null，然后再">
<meta name="keywords" content="Java">
<meta property="og:type" content="article">
<meta property="og:title" content="Java Tutorials-13-引用">
<meta property="og:url" content="https://beefyheisenberg.github.io/12.Java/Java-Tutorials.13.引用(Reference)/index.html">
<meta property="og:site_name" content="扔掉笔记 ᐛ">
<meta property="og:description" content="4种引用对比 强引用: 只要强引用还在就不会被 GC，JVM 宁愿抛出 OutOfMemoryError 错误也不会回收；  软引用(SoftReference): 用来描述非必需对象, GC 时发现内存不够时（Heap 内存超阈值）将会被回收。当垃圾回收器决定对其回收时，会先清空它的 SoftReference，也就是说 SoftReference 的 get() 方法将会返回 null，然后再">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2023-08-26T05:41:52.923Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java Tutorials-13-引用">
<meta name="twitter:description" content="4种引用对比 强引用: 只要强引用还在就不会被 GC，JVM 宁愿抛出 OutOfMemoryError 错误也不会回收；  软引用(SoftReference): 用来描述非必需对象, GC 时发现内存不够时（Heap 内存超阈值）将会被回收。当垃圾回收器决定对其回收时，会先清空它的 SoftReference，也就是说 SoftReference 的 get() 方法将会返回 null，然后再">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://beefyheisenberg.github.io/12.Java/Java-Tutorials.13.引用(Reference)/"/>





  <title>Java Tutorials-13-引用 | 扔掉笔记 ᐛ</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">扔掉笔记 ᐛ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">dropNotes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      


    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://beefyheisenberg.github.io/12.Java/Java-Tutorials.13.引用(Reference)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="beefyheisenberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/hexo_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="扔掉笔记 ᐛ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Java Tutorials-13-引用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/12-Java/" itemprop="url" rel="index">
                    <span itemprop="name">12.Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,081
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="4种引用对比"><a href="#4种引用对比" class="headerlink" title="4种引用对比"></a>4种引用对比</h1><ul>
<li><p>强引用: 只要强引用还在就不会被 GC，JVM 宁愿抛出 OutOfMemoryError 错误也不会回收；</p>
</li>
<li><p>软引用(<strong>SoftReference</strong>): 用来描述非必需对象, GC 时发现内存不够时（Heap 内存超阈值）将会被回收。当垃圾回收器决定对其回收时，会先清空它的 SoftReference，也就是说 SoftReference 的 <code>get()</code> 方法将会返回 null，然后再调用对象的 <code>finalize()</code> 方法，并在下一轮 GC 中对其真正进行回收。</p>
</li>
<li><p>弱引用(<strong>WeakReference</strong>): 也是用来描述非需对象的, 无论内存够不够，下次 GC 时一定都被回收, 但对象同时也被强引用持有，则不会回收；</p>
</li>
<li><p>虚引用(<strong>PhantomReference</strong>): PhantomReference 无法用来获取对象，其 get 方法永远返回 null，为一个对象设置虚引用关联的唯一目的是跟踪对象被垃圾回收的状态，通过查看引用队列中是否包含对象所对应的虚引用来判断它是否即将被垃圾回收，当 <code>PhantomReference</code> 被放入队列时，说明 referent 的 <code>finalize()</code> 方法已经调用，并且垃圾收集器准备回收它的内存了。</p>
</li>
<li><p>FinalReference 以及 Finzlizer：@todo</p>
</li>
</ul>
<p>相较于传统的引用计数算法，Java 使用可达性分析来判断一个对象是否存活。其基本思路是从 GC Root 开始向下搜索，如果对象与 GC Root 之间存在引用链，则对象是可达的。对象的可达性与引用类型密切相关。Java 有5中类型的可达性：</p>
<ol>
<li><p>强可达(Strongly Reachable)：如果线程能通过强引用访问到对象，那么这个对象就是强可达的。</p>
</li>
<li><p>软可达(Soft Reachable)：如果一个对象不是强可达的，但是可以通过软引用访问到，那么这个对象就是软可达的</p>
</li>
<li><p>弱可达(Weak Reachable)：如果一个对象不是强可达或者软可达的，但是可以通过弱引用访问到，那么这个对象就是弱可达的。</p>
</li>
<li><p>虚可达(Phantom Reachable)：如果一个对象不是强可达，软可达或者弱可达，并且这个对象已经finalize过了，并且有虚引用指向该对象，那么这个对象就是虚可达的。</p>
</li>
<li><p>不可达(Unreachable)：如果对象不能通过上述的几种方式访问到，则对象是不可达的，可以被回收。</p>
</li>
</ol>
<p><strong>How to Use:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ReferenceQueue&lt;String&gt; queue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;(); <span class="comment">// 对象被回收后, 被放入q里</span></span><br><span class="line"></span><br><span class="line">String str = <span class="keyword">new</span> String(<span class="string">"hello"</span>);</span><br><span class="line">WeakReference&lt;String&gt; softRef = <span class="keyword">new</span> WeakReference&lt;String&gt;(str, queue); <span class="comment">// 这一步后, 有两个引用指向"Hello"</span></span><br><span class="line">str = <span class="keyword">null</span>; <span class="comment">// 当String对象只有一个软引用指向它时, 才有可能被回收</span></span><br><span class="line">System.out.print(softRef.get()); <span class="comment">// 通过软引用调用对象用get方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设这里因内存不足发生了GC，被回收的软引用会被放入队列queue</span></span><br><span class="line"><span class="comment">// 从队列取出第一个:</span></span><br><span class="line">Reference&lt;? extends String&gt; ref = queue.poll();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ref != <span class="keyword">null</span>) &#123;  <span class="comment">// 从队列里取出的ref是个引用地址，非空</span></span><br><span class="line">  <span class="keyword">if</span>(ref.get() != <span class="keyword">null</span>) &#123; <span class="comment">// 对ref再次get，肯定返回null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 Soft、Weak、Phantom 三种引用的共同特点来看，都可以设置一个 ReferenceQueue，在 ref 关联的对象被回收时，ref 被放入 ReferenceQueue 中；</p>
<p>那么这个机制是如何实现的呢？</p>
<h2 id="ReferenceQueue-的工作机制"><a href="#ReferenceQueue-的工作机制" class="headerlink" title="ReferenceQueue 的工作机制"></a>ReferenceQueue 的工作机制</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reference</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> T referent;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// reference被回收后，当前 Reference实例会被添加到这个队列中</span></span><br><span class="line">  <span class="keyword">volatile</span> ReferenceQueue&lt;? <span class="keyword">super</span> T&gt; queue;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 全局唯一的 pending-Reference 列表</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Reference&lt;Object&gt; pending = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  ReferenceHandler &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 平时在 pending-Reference 上wait</span></span><br><span class="line">      <span class="comment">// CG收集器 把引用放入 pending-Reference后，此线程开始工作：</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// Reference 的static 代码中，创建 ReferenceHandler 线程：</span></span><br><span class="line">    Thread handler = <span class="keyword">new</span> ReferenceHandler();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Reference 其引用的对象被回收后，<strong>垃圾回收器</strong>将其加入到 Reference.pending 链表（所有的 Reference 共享一个链表）</li>
<li>Reference 类还包含一个 ReferenceHandler 线程（在 Reference 类的 static 代码中创建，同样是所有的 Reference 共享一个），此线程的从 pending-Reference 取出引用对象，将其加入它的 ReferenceQueue</li>
<li>用户的代码里读取 ReferenceQueue，自行处理</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* High-priority thread to enqueue pending References</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceHandler</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ensureClassInitialized</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               Class.forName(clazz.getName(), <span class="keyword">true</span>, clazz.getClassLoader());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">               <span class="keyword">throw</span> (Error) <span class="keyword">new</span> NoClassDefFoundError(e.getMessage()).initCause(e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">static</span> &#123;</span><br><span class="line">           <span class="comment">// pre-load and initialize InterruptedException and Cleaner classes</span></span><br><span class="line">           <span class="comment">// so that we don't get into trouble later in the run loop if there's</span></span><br><span class="line">           <span class="comment">// memory shortage while loading/initializing them lazily.</span></span><br><span class="line">           ensureClassInitialized(InterruptedException.class);</span><br><span class="line">           ensureClassInitialized(Cleaner.class);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ReferenceHandler(ThreadGroup g, String name) &#123;</span><br><span class="line">           <span class="keyword">super</span>(g, name);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">               tryHandlePending(<span class="keyword">true</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Try handle pending &#123;<span class="doctag">@link</span> Reference&#125; if there is one.&lt;p&gt;</span></span><br><span class="line"><span class="comment">    * Return &#123;<span class="doctag">@code</span> true&#125; as a hint that there might be another</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> Reference&#125; pending or &#123;<span class="doctag">@code</span> false&#125; when there are no more pending</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> Reference&#125;s at the moment and the program can do some other</span></span><br><span class="line"><span class="comment">    * useful work instead of looping.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> waitForNotify if &#123;<span class="doctag">@code</span> true&#125; and there was no pending</span></span><br><span class="line"><span class="comment">    *                      &#123;<span class="doctag">@link</span> Reference&#125;, wait until notified from VM</span></span><br><span class="line"><span class="comment">    *                      or interrupted; if &#123;<span class="doctag">@code</span> false&#125;, return immediately</span></span><br><span class="line"><span class="comment">    *                      when there is no pending &#123;<span class="doctag">@link</span> Reference&#125;.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if there was a &#123;<span class="doctag">@link</span> Reference&#125; pending and it</span></span><br><span class="line"><span class="comment">    *         was processed, or we waited for notification and either got it</span></span><br><span class="line"><span class="comment">    *         or thread was interrupted before being notified;</span></span><br><span class="line"><span class="comment">    *         &#123;<span class="doctag">@code</span> false&#125; otherwise.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">tryHandlePending</span><span class="params">(<span class="keyword">boolean</span> waitForNotify)</span> </span>&#123;</span><br><span class="line">       Reference&lt;Object&gt; r;</span><br><span class="line">       Cleaner c;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">               <span class="keyword">if</span> (pending != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   r = pending;</span><br><span class="line">                   <span class="comment">// 'instanceof' might throw OutOfMemoryError sometimes</span></span><br><span class="line">                   <span class="comment">// so do this before un-linking 'r' from the 'pending' chain...</span></span><br><span class="line">                   c = r <span class="keyword">instanceof</span> Cleaner ? (Cleaner) r : <span class="keyword">null</span>;</span><br><span class="line">                   <span class="comment">// unlink 'r' from 'pending' chain</span></span><br><span class="line">                   pending = r.discovered;</span><br><span class="line">                   r.discovered = <span class="keyword">null</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// The waiting on the lock may cause an OutOfMemoryError</span></span><br><span class="line">                   <span class="comment">// because it may try to allocate exception objects.</span></span><br><span class="line">                   <span class="keyword">if</span> (waitForNotify) &#123;</span><br><span class="line">                       lock.wait();</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">// retry if waited</span></span><br><span class="line">                   <span class="keyword">return</span> waitForNotify;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</span><br><span class="line">           <span class="comment">// Give other threads CPU time so they hopefully drop some live references</span></span><br><span class="line">           <span class="comment">// and GC reclaims some space.</span></span><br><span class="line">           <span class="comment">// Also prevent CPU intensive spinning in case 'r instanceof Cleaner' above</span></span><br><span class="line">           <span class="comment">// persistently throws OOME for some time...</span></span><br><span class="line">           Thread.yield();</span><br><span class="line">           <span class="comment">// retry</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException x) &#123;</span><br><span class="line">           <span class="comment">// retry</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Fast path for cleaners</span></span><br><span class="line">       <span class="keyword">if</span> (c != <span class="keyword">null</span>) &#123;</span><br><span class="line">           c.clean();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ReferenceQueue&lt;? <span class="keyword">super</span> Object&gt; q = r.queue;</span><br><span class="line">       <span class="keyword">if</span> (q != ReferenceQueue.NULL) q.enqueue(r);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">       ThreadGroup tg = Thread.currentThread().getThreadGroup();</span><br><span class="line">       <span class="keyword">for</span> (ThreadGroup tgn = tg;</span><br><span class="line">            tgn != <span class="keyword">null</span>;</span><br><span class="line">            tg = tgn, tgn = tg.getParent());</span><br><span class="line">       Thread handler = <span class="keyword">new</span> ReferenceHandler(tg, <span class="string">"Reference Handler"</span>);</span><br><span class="line">       <span class="comment">/* If there were a special system-only priority greater than</span></span><br><span class="line"><span class="comment">        * MAX_PRIORITY, it would be used here</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       handler.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">       handler.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">       handler.start();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// provide access in SharedSecrets</span></span><br><span class="line">       SharedSecrets.setJavaLangRefAccess(<span class="keyword">new</span> JavaLangRefAccess() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryHandlePendingReference</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">return</span> tryHandlePending(<span class="keyword">false</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h1 id="WeakHashMap"><a href="#WeakHashMap" class="headerlink" title="WeakHashMap"></a>WeakHashMap</h1><p>WeakHashMap 的特点：</p>
<ul>
<li>WeakHashMap 会“被动的”清理放入 Map 的 Entry，适用于程序内缓存的场景；</li>
<li>WeakHashMap.Entry ，出了继承 <code>Map.Entry&lt;K,V&gt;</code>，还继承了 WeakReference ；</li>
</ul>
<p><strong>How to Use:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">weakHashMapTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;COREJBasicType, String&gt; map = <span class="keyword">new</span> WeakHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    COREJBasicType key1 = <span class="keyword">new</span> COREJBasicType();</span><br><span class="line">    COREJBasicType key2 = <span class="keyword">new</span> COREJBasicType();</span><br><span class="line"></span><br><span class="line">    map.put(key1, <span class="keyword">new</span> String(<span class="string">"hello"</span>));</span><br><span class="line">    map.put(key2, <span class="keyword">new</span> String(<span class="string">"world"</span>));</span><br><span class="line"></span><br><span class="line">    System.gc();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;COREJBasicType, String&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        System.out.println(entry.getKey() + <span class="string">" "</span> + entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    key1 = <span class="keyword">null</span>; <span class="comment">// 帮助回收</span></span><br><span class="line">    System.gc();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;COREJBasicType, String&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        System.out.println(entry.getKey() + <span class="string">" "</span> + entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一次 gc 后，两个 Entry 都可以获取到，第二次 gc 后，遍历 WeakHashMap 只有 K2的 Entry 了；</p>
<p>WeakHashMap 自动回收的特性可以作为缓存来用, 例如 tomcat 的 ConcurrentCache。</p>
<h2 id="WeakHashMap-源码解析"><a href="#WeakHashMap-源码解析" class="headerlink" title="WeakHashMap 源码解析"></a>WeakHashMap 源码解析</h2><p>WeakHashMap 的主要属性:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeakHashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 桶数组</span></span><br><span class="line">        Entry&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 回收队列</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>put（k，val）：过程与 HashMap 类似，但需要注意的是 WeakHashMap.Entry:</p>
<ul>
<li>WeakHashMap 的桶数组定义是： <code>Entry&lt;K,V&gt;[] table</code></li>
<li>WeakHashMap.Entry 继承自 WeakReference；</li>
<li>WeakHashMap.Entry 的成员只有 value，没有 key（也就意味着 Entry 对象不会对 key 有强引用）；</li>
<li>put 方法传入的 key，被转换为了一个弱引用，同时该弱引用关联 WeakHashMap.queue ：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Entry(Object key, V value,</span><br><span class="line">    ReferenceQueue&lt;Object&gt; queue,</span><br><span class="line">    <span class="keyword">int</span> hash, Entry&lt;K,V&gt; next) &#123;</span><br><span class="line">  <span class="keyword">super</span>(key, queue); <span class="comment">// super() 即 WeakReference(req,queue)</span></span><br><span class="line">  <span class="keyword">this</span>.value = value; </span><br><span class="line">  <span class="keyword">this</span>.hash  = hash;</span><br><span class="line">  <span class="keyword">this</span>.next  = next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当把一个 Entry put 后，再分析一下对象的可达性：</p>
<ul>
<li>如果 weakHashMap 是强可达的，那么 entry 对象也是强可达；</li>
<li>value 对象被 entry.value 引用，强可达；</li>
<li>key 对象只有一个弱引用关联（弱可达），所以会被 GC 掉，同时 GC 线程把 Key 关联的弱引用，放入 WeakHashMap 对象的 queue；</li>
</ul>
<p>那么WeakHashMap 是如何回收 value 的?</p>
<p>在 <code>get()</code>  <code>put()</code>, <code>size()</code> 方法里都会先调用一个 <code>expungeStaleEntries()</code> 方法,<br>此方法遍历 ReferenceQueue 取出每个弱引用（因为 Entry 继承自 WeakReference），把 Entry.val 设置为 null 帮助回收：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expungeStaleEntries</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">for</span> (Object x; (x = queue.poll()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">         <span class="keyword">synchronized</span> (queue) &#123;</span><br><span class="line">             <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">             Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;) x; <span class="comment">// （1）convert Key to Entry？</span></span><br><span class="line"></span><br><span class="line">             <span class="keyword">int</span> i = indexFor(e.hash, table.length);</span><br><span class="line"></span><br><span class="line">             Entry&lt;K,V&gt; prev = table[i];</span><br><span class="line">             Entry&lt;K,V&gt; p = prev;</span><br><span class="line">             <span class="keyword">while</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 Entry&lt;K,V&gt; next = p.next;</span><br><span class="line">                 <span class="keyword">if</span> (p == e) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (prev == e)</span><br><span class="line">                         table[i] = next;</span><br><span class="line">                     <span class="keyword">else</span></span><br><span class="line">                         prev.next = next;</span><br><span class="line">                     <span class="comment">// Must not null out e.next;</span></span><br><span class="line">                     <span class="comment">// stale entries may be in use by a HashIterator</span></span><br><span class="line">                     e.value = <span class="keyword">null</span>; <span class="comment">//（2） Help GC</span></span><br><span class="line">                     size--;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 prev = p;</span><br><span class="line">                 p = next;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>代码（2）处把 Entry.value 设置为 null 帮助回收 @doubt: <code>Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;) x</code> ，x 是从 queue 里取出的，也即 Reference<key> 类型，是如何转换为 Entry 类型的？</key></p>
<hr>
<p>@ref:</p>
<ul>
<li><a href="https://www.cnblogs.com/CarpenterLee/p/5544598.html" target="_blank" rel="noopener">浅谈WeakHashMap - CarpenterLee - 博客园</a></li>
<li><a href="https://mp.weixin.qq.com/s/BYpwmwRlF0Ve7kBRZUpdLw" target="_blank" rel="noopener">JDK 源码阅读 Reference</a></li>
<li><a href="https://www.zhihu.com/question/63932795" target="_blank" rel="noopener"> WeakHashMap中关于queue的疑惑 ？ - 知乎</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/12.Java/Java-Tutorials.12.新特性/" rel="next" title="Java Tutorials-12-新特性（Java8~12）">
                <i class="fa fa-chevron-left"></i> Java Tutorials-12-新特性（Java8~12）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/12.Java/Java-Tutorials.14.代理(Proxy)/" rel="prev" title="Java Tutorials-14-代理">
                Java Tutorials-14-代理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/hexo_avatar.png"
                alt="beefyheisenberg" />
            
              <p class="site-author-name" itemprop="name">beefyheisenberg</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">476</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">410</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/yourname" target="_blank" title="Facebook">
                      
                        <i class="fa fa-fw fa-facebook"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.instagram.com/_kongyang/" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#4种引用对比"><span class="nav-text">4种引用对比</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ReferenceQueue-的工作机制"><span class="nav-text">ReferenceQueue 的工作机制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WeakHashMap"><span class="nav-text">WeakHashMap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#WeakHashMap-源码解析"><span class="nav-text">WeakHashMap 源码解析</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 &mdash; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">beefyheisenberg</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://beefyheisenberg.github.io/12.Java/Java-Tutorials.13.引用(Reference)/';
          this.page.identifier = '12.Java/Java-Tutorials.13.引用(Reference)/';
          this.page.title = 'Java Tutorials-13-引用';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://dropnotes-2.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  

</body>
</html>
